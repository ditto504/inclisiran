---
title: "inclisiran patient filter"
author: "LI, Yuxi, MD"
date: "2021/3/18"
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 准备

在开始患者筛选之前，我们需要载入一些基础的R语言的包，用来进行数据清洗和处理。其中，tidyverse是一个系列包，里面包含了所有数据处理、数据表连接筛选的功能。
```{r message=FALSE, warning=FALSE}
library(tidyverse)
#set date time style
options(scipen = 50)
```

## 患者队列筛选

### 基本筛选思路

客观的讲，ORION 18应该并不是一个入选很困难的研究。因为根据ORION 18研究的入选和排除标准，只要符合ASCVD，且LDL-C≥1.8mmol/L，且服用稳定的（≥30天）可耐受最大剂量他汀（无论是否包括依折麦布）就可以入选。或是高危ASCVD，LDL-C≥2.6mmol/L。因此，很自然的，我们想到有两大类患者可以利用EHR数据精准筛选患者。

1. 已经住院，确诊了ASCVD的患者，且在门诊随访中记录了LDL-C；

2. 纯门诊，通过诊断与检验系统进行筛选、甚至实时监测；

### 住院患者的筛选

#### 数据准备

首先，我们从`\data`里读入患者住院信息表；

```{r message=FALSE, warning=FALSE}
in_patient <- read_csv('data/in_patient.csv')
```

```{r}
glimpse(in_patient)
```

```{r paged.print=TRUE}
head(in_patient)
```

然后，我们读取患者唯一识别码EMPI。

```{r message=FALSE, warning=FALSE}
empi<-read_csv("data/empi.csv")
```

```{r}
glimpse(empi)
```

```{r paged.print=TRUE}
head(empi)
```

```{r}
tmp<-
empi%>%
  select(pid,empi)
```

#### 末次住院

接下来，我们要选取每一位患者的末次住院信息，作为基线信息。

这里面，我们利用了`arrange`（排序）以及`distinct`（唯一）的算法，并得到我们希望的患者列表。

```{r}
final<-
in_patient%>%
  left_join(tmp,by=c("pid"))%>%
  filter(!is.na(empi))%>%
  arrange(pid,desc(in_datetime))%>%
  distinct(empi,.keep_all = TRUE)%>%
  select(-X1)
```

我们来看一下患者的时间跨度

```{r}
summary(final$in_datetime)
```

#### 末次化验
```{r message=FALSE, warning=FALSE}
lis_sample_in <- read_csv("data/lis_sample.csv")
```

```{r}
lis_sample_in <- select(lis_sample_in, -X1)
```

```{r}
glimpse(lis_sample_in)
```

```{r}
head(lis_sample_in)
```

```{r message=FALSE, warning=FALSE}
lis_result_in <- read_csv("data/lis_result.csv")
```

```{r}
glimpse(lis_result_in)
```

```{r}
head(lis_result_in)
```


```{r}
lis_result_in%>%
  #filter(str_detect(tolower(ENGLISH_NAME),"ldl"))%>%
  filter(str_detect(CHINESE_NAME,"低密度"))%>%
  group_by(ENGLISH_NAME,CHINESE_NAME)%>%
  summarise(n=n())
```

```{r}
tmp<-
lis_sample_in%>%
  filter(!is.na(empi))%>%
  semi_join(final,by=c("empi"))
```

```{r}
tmp<-
lis_result_in%>%
  filter(ENGLISH_NAME %in% c("LDL-C"))%>%
  left_join(tmp, by="sid")%>%
  select(empi,ENGLISH_NAME,QUANTITATIVE_RESULT,sampling_time)%>%
  filter(!is.na(empi))
```

```{r}
tmp<-
tmp%>%
  arrange(empi,sampling_time)%>%
  group_by(empi)%>%
  summarise(
    last_ldl_time=last(sampling_time),
    last_ldl=last(sampling_time)
  )
```

### 缺失比例
```{r}
final%>%
  left_join(tmp,by=c("empi"))%>%
  summarise_all(list(function(x) sum(is.na(x))/length(x)))
```

### 更新final数据
```{r}
final<-
final%>%
  left_join(tmp,by=c("empi"))%>%
  filter(!is.na(last_ldl))
```

## 筛选1
```{r}
glimpse(final)
```

```{r}
#out<-
final%>%
  filter(last_ldl>1.8)%>%
  arrange(desc(last_ldl_time,last_ldl))%>%
  select(empi,pid,out_datetime,dept,last_ldl_time,last_ldl)%>%
  mutate(followup=as.Date(last_ldl_time)-as.Date(out_datetime))%>%
  filter(followup>0)%>%
  arrange(desc(last_ldl_time))%>%
  left_join(select(empi,empi,name,sex,birthday),by=c("empi"))%>%
  mutate(age=round(as.numeric(difftime(as.Date(last_ldl_time),birthday,units="days"))/365.25))
```

### 导出
```{r}
#write.csv(out,"data/inclisiran/more20210316.csv")
```

## 出院带药降脂方案
```{r message=FALSE, warning=FALSE}
meds <- read_csv('data/meds.csv',trim_ws = TRUE)
```

```{r}
glimpse(meds)
```

```{r}
head(meds,20)
```


```{r}
tmp<-
meds%>%
  filter(str_detect(tolower(ADVICE_CONTENT),"(他汀)"))%>%
  arrange(pflow,med_time)%>%
  mutate(statin_type=case_when(
    str_detect(ADVICE_CONTENT,"阿托伐")~"阿托伐",
    str_detect(ADVICE_CONTENT,"瑞舒伐")~"瑞舒伐",
    str_detect(ADVICE_CONTENT,"普伐")~"普伐",
    str_detect(ADVICE_CONTENT,"辛伐")~"辛伐",
    str_detect(ADVICE_CONTENT,"氟伐")~"氟伐",
    str_detect(ADVICE_CONTENT,"匹伐")~"匹伐"
  ))%>%
  group_by(pflow)%>%
  summarise(
    statin_type=last(statin_type),
    dose=last(DOSAGE)
  )%>%
  ungroup()
```

```{r}
tmp1<-
meds%>%
  filter(str_detect(tolower(ADVICE_CONTENT),"(依折麦布)"))%>%
  select(pflow,med_time)%>%
  mutate(emab=1)%>%
  group_by(pflow)%>%
  summarise(
    emab=max(emab)
  )%>%
  ungroup()
```
### 缺失比例
```{r}
final%>%
  left_join(tmp,by=c("pflow"))%>%
  left_join(tmp1,by=c("pflow"))%>%
  summarise_all(list(function(x) sum(is.na(x))/length(x)))
```
### 更新final数据
```{r}
final<-
final%>%
  left_join(tmp,by=c("pflow"))%>%
  left_join(tmp1,by=c("pflow"))%>%
  filter(!is.na(statin_type))
```

## 筛选2
```{r}
glimpse(final)
```

```{r}
#out<-
final%>%
  #filter(!is.na(statin_type))%>%
  mutate(max=case_when(
    (statin_type=="阿托伐"&dose>=40)~"y",
    (statin_type=="瑞舒伐"&dose>=20)~"y",
    (statin_type=="辛伐"&dose>=20)~"y",
    (statin_type=="匹伐"&dose>=4)~"y"
  ))%>%
  filter(last_ldl>1.8&max=="y")%>%
  arrange(desc(last_ldl,last_ldl_time))%>%
  select(empi,pid,out_datetime,dept,last_ldl_time,last_ldl,statin_type,dose,emab,max)%>%
  mutate(followup=as.Date(last_ldl_time)-as.Date(out_datetime))%>%
  filter(followup>0)%>%
  arrange(desc(last_ldl_time))%>%
  left_join(select(empi,empi,name,sex,birthday),by=c("empi"))%>%
  mutate(age=round(as.numeric(difftime(as.Date(last_ldl_time),birthday,units="days"))/365.25))%>%
  select(-birthday)
```

## 导出
```{r}
#write.csv(out,"data/inclisiran/out20210316.csv")
```
